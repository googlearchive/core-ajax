<!doctype html>
<!--
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
  <title>core-ajax</title>
  <script src="../../webcomponentsjs/webcomponents.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../core-ajax.html">
</head>
<body>

<core-ajax></core-ajax>

<script>
  describe("core-ajax", function() {
    var xhr, coreAjax, requests;

    beforeEach(function() {
      coreAjax = document.querySelector("core-ajax");
      coreAjax.poll = undefined;
      coreAjax.url = 'http://example.com';
      coreAjax.auto = false; // turn off requesting sending the request on load
      xhr = sinon.useFakeXMLHttpRequest();
      xhr.onCreate = function (req) { requests.push(req); };
      requests = []
    });

    describe('with poll attribute set', function() {
      it('should repeat the request', function(doneCallback) {
        coreAjax.poll = 10;
        expect(requests.length).to.equal(0);
        coreAjax.go();
        expect(requests.length).to.equal(1);
        requests[0].respond(200);
        setTimeout(function() {
          expect(requests.length).to.equal(2);
          doneCallback();
        }, 11);
      });

      it('should not repeat the request if the previous request ' +
      'failed', function(doneCallback) {
        coreAjax.poll = 10;
        expect(requests.length).to.equal(0);
        coreAjax.go();
        expect(requests.length).to.equal(1);
        requests[0].respond(400);
        setTimeout(function() {
          expect(requests.length).to.equal(1);
          doneCallback();
        }, 11);
      });
    });

    describe('without poll attribute', function() {
      it('should not poll', function(doneCallback) {
        console.log('has poll?', coreAjax.poll);
        expect(requests.length).to.equal(0);
        coreAjax.go();
        expect(requests.length).to.equal(1);
        requests[0].respond(200);
        setTimeout(function() {
          expect(requests.length).to.equal(1);
          doneCallback();
        }, 11);
      });
    });
  });
</script>
</body>
</html>
