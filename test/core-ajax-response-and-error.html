<!doctype html>
<!--
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
  <title>core-ajax</title>

  <script src="../../webcomponentsjs/webcomponents.js"></script>
  <script src="../../web-component-tester/browser.js"></script>

  <!--
    Test that when core-ajax fires multiple times as requests are updated,
    only the response from the most recent request is used to update the response
    object.
  -->
  <script>
    test('race-condition', function(done) {
      var ajax = document.querySelector("core-ajax");
      var xhr = sinon.useFakeXMLHttpRequest();
      xhr.onCreate = function (xhr) {
        var headers = {
          "Content-Type": "text/html"
        }
        var body = '{"url": "' + xhr.url + '"}';
        if (xhr.url.match('request1')) {
          window.setTimeout(function(){
            xhr.respond(200, headers, body);
            console.log('response 1 received');
          }, 200);
        } else if (xhr.url.match('request2')) {
          window.setTimeout(function(){
            xhr.respond(200, headers, body);
            console.log('response 2 received');
          }, 100);
        }
      };
      // Make a request that will return in .2 seconds.
      ajax.url="http://example.org/request1";
      // Make a request that will return in .1 seconds.
      ajax.url="http://example.org/request2";
      // Wait for the requests to resolve, then check that the later return
      // of request1 doesn't override.
      setTimeout(function(){
        assert(ajax.response.match('request1'),
          "Race condition detected. An earlier request's delayed response " +
              "caused the more recent request's response to be overwritten.");
      }, 300);
      console.log("test done");
      done();
    });
  </script>

  <link rel="import" href="../core-ajax.html">

</head>
<body>

  <core-ajax
    handleAs="json"
    auto></core-ajax>

</body>
</html>
