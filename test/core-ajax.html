<!doctype html>
<!--
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
  <title>core-ajax</title>

  <script src="../../webcomponentsjs/webcomponents.js"></script>
  <script src="../../web-component-tester/browser.js"></script>

  <link rel="import" href="../core-ajax.html">

</head>
<body>
  <core-ajax></core-ajax>

  <script>
  suite('core-ajax', function() {
    var xhr, requests, ajax;
    suiteSetup(function() {
      xhr = sinon.useFakeXMLHttpRequest();
      ajax = document.querySelector("core-ajax");
    });
    setup(function() {
      requests = [];
      xhr.onCreate = function (xhr) {
        requests.push(xhr);
      };
      // Reset the core-ajax element before each test.
      ajax.auto = false;
      ajax.url = '';
      ajax.params = '';
      ajax.handleAs = 'text';
      ajax.body = '';
    });
    suite('handleAs', function() {
      suite('text', function(){
        var headers = {
          "Content-Type": "text/plain"
        };
        setup(function(done){
          async.series([
            function(cb){
              ajax.handleAs = 'text';
              ajax.url = "http://example.com/text"
              ajax.auto = true;
              cb();
            },
            flush,
            function(cb) {
              requestAnimationFrame(function(){
                cb();
              });
            },
            function(cb){
              requests[0].respond(200, headers, "test text");
              cb();
            }
            ], done);
        });
        test('Raw text should pass through', function(){
          assert.equal(ajax.response, "test text")
        })
      });
      suite('xml', function(){
        var headers = {
          "Content-Type": "text/xml"
        };
        setup(function(done){
          async.series([
            function(cb){
              ajax.handleAs = 'xml';
              ajax.url = "http://example.com/xml"
              ajax.auto = true;
              cb();
            },
            flush,
            function(cb) {
              requestAnimationFrame(function(){
                cb();
              });
            },
            function(cb){
              requests[0].respond(200, headers,
                          "<note>" +
                          "<to>AJ</to>" +
                          "<from>Dog</from>" +
                          "<subject>Reminder</subject>" +
                          "<body><q>Feed me!</q></body>" +
                          "</note>");
              cb();
            }
            ], done);
        });
        test('XML should be returned with queryable structure', function(){
          var q = ajax.response.querySelector("note body q");
          assert.equal(q.innerHTML, "Feed me!");
          var to = ajax.response.querySelector("to");
          assert.equal(to.innerHTML, "AJ");
        })});
      suite('json', function(){
        var headers = {
          "Content-Type": "text/json"
        };
        setup(function(done){
          async.series([
            function(cb){
              ajax.handleAs = 'json';
              ajax.url = "http://example.com/json"
              ajax.auto = true;
              cb();
            },
            flush,
            function(cb) {
              requestAnimationFrame(function(){
                cb();
              });
            },
            function(cb){
              requests[0].respond(200, headers,
                          '{"object" : {"list" : [2, 3, {"key": "value"}]}}');
              cb();
            }
            ], done);
        });
        test('JSON should be returned as an Object', function(){
          var r = ajax.response;
          assert.equal(r.object.list[1], 3);
          assert.equal(r.object.list[2].key, "value");
        });
      });
      suite('arraybuffer', function(){});
      suite('blob', function(){});
      suite('document', function(){});
    });
    suite('auto', function() {
      test('url', function(){});
      test('params', function(){});
      test('body', function(){});
    });
    suite('events', function(){
      suite('core-response', function(){});
      suite('core-error', function(){});
      suite('core-complete', function(){});
    });
  });
  </script>

</body>
</html>
